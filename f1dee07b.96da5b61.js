(window.webpackJsonp=window.webpackJsonp||[]).push([[124],{198:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return b})),a.d(t,"metadata",(function(){return r})),a.d(t,"rightToc",(function(){return o})),a.d(t,"default",(function(){return u}));var n=a(2),l=a(6),i=(a(0),a(218)),b={title:"InfluxDB line protocol on QuestDB",author:"David G. Simmons",author_title:"QuestDB Team",author_url:"https://github.com/davidgs",author_image_url:"https://avatars.githubusercontent.com/davidgs",description:"How to use InfluxDB line protocol with QuestDB, this example shows an IoT application.",tags:["influxdb line protocol"]},r={permalink:"/blog/2020/07/22/influxdb-lp-on-tcp",source:"@site/blog/2020-07-22-influxdb-lp-on-tcp.md",description:"How to use InfluxDB line protocol with QuestDB, this example shows an IoT application.",date:"2020-07-22T00:00:00.000Z",tags:[{label:"influxdb line protocol",permalink:"/blog/tags/influxdb-line-protocol"}],title:"InfluxDB line protocol on QuestDB",readingTime:5.615,truncated:!0,prevItem:{title:"Use QuestDB and get swag!",permalink:"/blog/2020/07/24/use-questdb-for-swag"},nextItem:{title:"Demo launch on HackerNews postmorterm",permalink:"/blog/2020/07/01/we-put-a-sql-database-on-the-internet"}},o=[{value:"Configuring TCP InfluxDB line protocol listener",id:"configuring-tcp-influxdb-line-protocol-listener",children:[]},{value:"InfluxDB line protocol refresher",id:"influxdb-line-protocol-refresher",children:[{value:"Basic structure",id:"basic-structure",children:[]},{value:"Example ILP",id:"example-ilp",children:[]}]},{value:"Database structure",id:"database-structure",children:[]},{value:"But how did you write that?",id:"but-how-did-you-write-that",children:[]},{value:"Can I do batch writes?",id:"can-i-do-batch-writes",children:[]},{value:"Conclusions",id:"conclusions",children:[]}],c={rightToc:o};function u(e){var t=e.components,b=Object(l.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},c,b,{components:t,mdxType:"MDXLayout"}),Object(i.b)("img",{alt:"Blue sky surrounded by latice-work",className:"banner",src:"/img/blog/2020-07-22/banner.jpg"}),Object(i.b)("div",{className:"banner",style:{fontSize:"14px",marginBottom:"1rem"}},"Photo by\xa0",Object(i.b)("a",{href:"https://unsplash.com/@ripato?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"},"Ricardo Gomez Angel"),"\xa0on\xa0",Object(i.b)("a",{href:"https://unsplash.com/collections/1231819/influx?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"},"Unsplash")),Object(i.b)("p",null,"We've had a UDP version of the InfluxDB Line Protocol (ILP) reader in QuestDB\nfor quite some time, but we've had customers ask for a TCP version of it, so we\ndelivered!"),Object(i.b)("p",null,"Using it, and configuring it, are relatively simple so don't expect this to be a\nlong post but I'll walk you through the basics of how to set it up and use it.\nFor an added bonus I'll show you how to migrate from using InfluxDB to using\nQuestDB with a less than a line of configuration."),Object(i.b)("h2",{id:"configuring-tcp-influxdb-line-protocol-listener"},"Configuring TCP InfluxDB line protocol listener"),Object(i.b)("p",null,"Here's the best part, at least for a basic implementation that you don't need to\nperformance tune at all: It's already set up."),Object(i.b)("p",null,"That's right, as soon as you start QuestDB both the UDP and TCP ILP listeners\nstart automatically on port 9009. Yes, TCP and UDP both use the same port. No,\nthat's not a problem since one is UDP and one is TCP."),Object(i.b)("p",null,"There are a bunch of configuration options you can tune in your\n",Object(i.b)("inlineCode",{parentName:"p"},"conf/server.conf")," file if you're interested. I won't go through them here, but\nyou can read all about them in our ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/api/influxdb-line-protocol/"}),"docs"),". I\nhope they are relatively self-explanatory."),Object(i.b)("h2",{id:"influxdb-line-protocol-refresher"},"InfluxDB line protocol refresher"),Object(i.b)("p",null,"If you have used ILP before, this should all be review. If you're new to ILP,\nthis will tell you how you should write your data to QuestDB."),Object(i.b)("h3",{id:"basic-structure"},"Basic structure"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell",metastring:'title="ILP syntax"',title:'"ILP','syntax"':!0}),"table_name,tagset valueset timestamp\n")),Object(i.b)("p",null,"Pretty basic. So let's dive into what each element actually is, and how to\nstructure a line of ILP for writing."),Object(i.b)("p",null,"The first element is the ",Object(i.b)("inlineCode",{parentName:"p"},"table_name")," portion, which tells the ILP writer which\ndatabase table to write values into."),Object(i.b)("p",null,"Next comes the set of tags you want to use. These are standard ",Object(i.b)("inlineCode",{parentName:"p"},"key=value"),"\npairs, and you can add as many of them as you want or need. Just separate them\nwith commas."),Object(i.b)("p",null,"There should only ever be 2 spaces in your line protocol. No more. The first\nspace separates your ",Object(i.b)("inlineCode",{parentName:"p"},"tags")," from the ",Object(i.b)("inlineCode",{parentName:"p"},"values")," you want to associate with those\n",Object(i.b)("inlineCode",{parentName:"p"},"tags"),"s. The second space separates the values from the timestamp for those tags\nand values."),Object(i.b)("p",null,"The values are also ",Object(i.b)("inlineCode",{parentName:"p"},"key=value")," pairs, and again you can send as many as you\nwant in a line."),Object(i.b)("p",null,"Finally comes your ",Object(i.b)("inlineCode",{parentName:"p"},"timestamp")," value, typically in \xb5Seconds."),Object(i.b)("h3",{id:"example-ilp"},"Example ILP"),Object(i.b)("p",null,"Let's use an example of writing some environmental data to QuestDB. I have a\nsensor that reads temperature, atmospheric pressure, humidity, and the altitude."),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Reading"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Value"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Temperature"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"23.180000")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Humidity"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"51.982422")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Pressure"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"1002.112061")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Altitude"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"93.146370")))),Object(i.b)("p",null,"And I want to use the following ",Object(i.b)("inlineCode",{parentName:"p"},"tag"),"s:"),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Tag Name"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Tag Value"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"dev_id"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"THP002")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"dev_loc"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Apex")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"dev_name"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"BME280")))),Object(i.b)("p",null,"And my ",Object(i.b)("inlineCode",{parentName:"p"},"table_name")," is ",Object(i.b)("inlineCode",{parentName:"p"},"iot")),Object(i.b)("p",null,"Now I have all the basic elements I need to construct my ILP, which will look\nlike this:"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"iot,dev_id=THP002,dev_loc=Apex,dev_name=BME280 temp_c=23.18,altitude=93.10,humidity=52.16,pressure=1002.12")),Object(i.b)("p",null,"And yes, I rounded those values. But you'll notice that I did not add a\n",Object(i.b)("inlineCode",{parentName:"p"},"timestamp")," value. In this case, it's because I am sending the values from a\nsmall, embedded sensor device that really doesn't have a great sense of time. By\nsending the ILP without a ",Object(i.b)("inlineCode",{parentName:"p"},"timestamp")," I'm telling the database itself to add one\nfor me, using the arrival time as the ",Object(i.b)("inlineCode",{parentName:"p"},"timestamp"),"."),Object(i.b)("h2",{id:"database-structure"},"Database structure"),Object(i.b)("p",null,"One of the cool features of using the ILP reader (well, QuestDB in general\nreally) is the ability to do 'Schema on Write'."),Object(i.b)("p",null,"What that means is that if an ILP message arrives, QuestDB will automatically\ncreate tables and columns to fit the incoming ILP. So if you need to add a ",Object(i.b)("inlineCode",{parentName:"p"},"tag"),"\nlater, you can add it to the new device's tagset and start writing. The new tag\nwill get added to the schema."),Object(i.b)("p",null,"If you leave a tag value off, and it exists in the database, it will get filled\nwith a ",Object(i.b)("inlineCode",{parentName:"p"},"null")," value."),Object(i.b)("p",null,"When I start writing the above ILP to QuestDB, I'll get a table that looks like\nthis:"),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"dev_id"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"dev_name"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"temp_c"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"humidity"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"timestamp"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"dev_loc"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"altitude"),Object(i.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"pressure"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"THP002"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"BME280"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"26.52"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"51.94"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"2020-07-21T14:54:59.156202Z"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Apex"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"76.27"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"1004.12")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"THP002"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"BME280"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"26.54"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"51.85"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"2020-07-21T14:54:59.157358Z"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Apex"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"75.97"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"1004.16")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"THP002"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"BME280"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"26.56"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"51.83"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"2020-07-21T14:54:59.157389Z"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Apex"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"75.84"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"1004.17")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"THP002"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"BME280"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"26.58"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"51.79"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"2020-07-21T14:54:59.287416Z"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Apex"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"75.93"),Object(i.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"1004.16")))),Object(i.b)("p",null,"This is what that table looks like in the QuestDB Web Console:"),Object(i.b)("p",null,Object(i.b)("img",{alt:"Table in QuestDB Web Console",src:a(377).default})),Object(i.b)("h2",{id:"but-how-did-you-write-that"},"But how did you write that?"),Object(i.b)("p",null,"Oh, so how did I write that ILP to QuestDB? Well, my sensor is an Arduino, with\na Bosch BME280 sensor attached. It is WiFi connected, so a ",Object(i.b)("inlineCode",{parentName:"p"},"WiFiClient")," can do\nthe TCP write for me:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-C",metastring:'title="WiFiClient Connect"',title:'"WiFiClient','Connect"':!0}),"espClient.connect(Quest_Server, 9009);\n")),Object(i.b)("p",null,"Will connect the client to the QuestDB Server defined by ",Object(i.b)("inlineCode",{parentName:"p"},"Quest_Server")," on port\n",Object(i.b)("inlineCode",{parentName:"p"},"9009"),"."),Object(i.b)("p",null,"If I then have a line of ILP like this:\n",Object(i.b)("inlineCode",{parentName:"p"},"iot,dev_id=THPL002,dev_loc=Demo,dev_name=BME280 temp_c=23.18,altitude=93.10,humidity=52.16,pressure=1002.12\\n"),"\nin a ",Object(i.b)("inlineCode",{parentName:"p"},"buffer")," I can call ",Object(i.b)("inlineCode",{parentName:"p"},"espClient.printf(buffer);")," and that line of data will\nbe written to QuestDB."),Object(i.b)("h2",{id:"can-i-do-batch-writes"},"Can I do batch writes?"),Object(i.b)("p",null,"Of course you can! Just put each line of ILP on a separate 'line', separated by\na newline ",Object(i.b)("inlineCode",{parentName:"p"},"\\n")," and then when you have all your batch built up, write the whole\nthing to QuestDB."),Object(i.b)("p",null,"Of course, if you're relying on QuestDB to add ",Object(i.b)("inlineCode",{parentName:"p"},"timestamps")," for you, then just\nbe aware that the entire batch will be given sequential timestamps based on when\nthey are read/written to the database."),Object(i.b)("h2",{id:"conclusions"},"Conclusions"),Object(i.b)("p",null,"InfluxDB Line Protocol (ILP) is a simple, well-known, and relatively compact\ndata format for sending Time Series data to a database. That's why we decided to\nsupport it."),Object(i.b)("p",null,"As I told you in the beginning, I'm now going to give you a simple,\nless-than-one-line configuration change to migrate from using InfluxDB to using\nQuestDB. If you're using Telegraf as a data collector, that is."),Object(i.b)("p",null,"Edit your ",Object(i.b)("inlineCode",{parentName:"p"},"/etc/telegraf.conf")," file (it may be in different places, depending on\nyour operating system) and change the line:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'[[outputs.influxdb]]\n  urls = ["http://127.0.0.1:8086"]\n')),Object(i.b)("p",null,"to be:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'[[outputs.influxdb]]\n  urls = ["tcp://127.0.0.1:9009"]\n')),Object(i.b)("p",null,"That's it. That's the migration. Now all data that was previously being written\nto InfluxDB will now be written to QuestDB."))}u.isMDXComponent=!0},377:function(e,t,a){"use strict";a.r(t),t.default=a.p+"assets/images/tableShot-5a098be4e04497b06903a3de299d76b3.png"}}]);