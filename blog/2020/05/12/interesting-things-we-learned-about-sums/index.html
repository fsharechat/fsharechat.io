<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="fsharechat">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@questdb">
<meta name="generator" content="Docusaurus v2.0.0-alpha.64">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="shortcut icon" href="https://https://fsharechat.github.io//img/favicon.png">
<link rel="apple-touch-icon" sizes="48x48" href="/img/icons/icon-48x48.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/icons/icon-72x72.png">
<link rel="apple-touch-icon" sizes="96x96" href="/img/icons/icon-96x96.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/icons/icon-144x144.png">
<link rel="apple-touch-icon" sizes="192x192" href="/img/icons/icon-192x192.png">
<link rel="apple-touch-icon" sizes="256x256" href="/img/icons/icon-256x256.png">
<link rel="apple-touch-icon" sizes="384x384" href="/img/icons/icon-384x384.png">
<link rel="apple-touch-icon" sizes="512x512" href="/img/icons/icon-512x512.png">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Time series data, faster Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Time series data, faster Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PVR7M2G"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-PVR7M2G",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Time series data, faster" href="/opensearch.xml">
<link rel="icon" href="/img/favicon.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="apple-touch-icon" href="/img/favicon.png">
<link rel="mask-icon" href="/img/favicon.png" content="#fff">
<meta name="msapplication-TileImage" content="/img/favicon.png">
<meta name="msapplication-TileColor" content="#21222c"><title data-react-helmet="true">Things we learned about sums | Time series data, faster</title><meta data-react-helmet="true" name="description" content="What we learned implementing Kahan and Neumaier compensated sum algorithms, benchmark and comparison with Clickhouse."><meta data-react-helmet="true" property="og:image" content="https://https://fsharechat.github.io//img/og.png"><meta data-react-helmet="true" property="og:url" content="https://https://fsharechat.github.io/"><meta data-react-helmet="true" property="og:title" content="Things we learned about sums | Time series data, faster"><meta data-react-helmet="true" property="og:description" content="What we learned implementing Kahan and Neumaier compensated sum algorithms, benchmark and comparison with Clickhouse."><meta data-react-helmet="true" name="twitter:image" content="https://https://fsharechat.github.io//img/og.png"><meta data-react-helmet="true" name="twitter:description" content="What we learned implementing Kahan and Neumaier compensated sum algorithms, benchmark and comparison with Clickhouse."><meta data-react-helmet="true" name="twitter:title" content="Things we learned about sums | Time series data, faster"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Things we learned about sums | Time series data, faster&quot;"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link rel="stylesheet" href="/styles.2a8a7e1b.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="Fast SQL open source database for time series - QuestDB">
<meta itemprop="description" content="QuestDB is an open source database designed to make time-series lightning fast and easy. It exposes a high performance REST API and supports Postgres wire.">
<meta itemprop="url" content="https://https://fsharechat.github.io/">
<meta itemprop="logo" content="https://https://fsharechat.github.io//img/favicon.png">
<meta itemprop="sameAs" content="https://twitter.com/questdb">
<meta itemprop="sameAs" content="https://www.linkedin.com/company/questdb/">
<meta itemprop="sameAs" content="https://www.crunchbase.com/organization/quest-db">
<meta itemprop="sameAs" content="https://github.com/questdb">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner inner_3txf"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_9Wyn" href="/"><img alt="QuestDB" class="navbar__logo" src="/img/navbar/fshare.svg"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Install</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/guide/docker/">Docker</a></li><li><a class="dropdown__link" position="left" href="/docs/guide/homebrew/">Homebrew</a></li><li><a class="dropdown__link" position="left" href="/docs/guide/binaries/">From the binaries</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/introduction/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/questdb/questdb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__item--github">GitHub</a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">⌘</span><span class="DocSearch-Button-Key">K</span></button><a class="getStarted_1xnS button_Ni2_ button--primary_316O button--uppercase_35Ce button--xsmall_3jz_" href="/getstarted/">Get Started</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_9Wyn" href="/"><img alt="QuestDB" class="navbar__logo" src="/img/navbar/fshare.svg"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist">Install</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/guide/docker/">Docker</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/guide/homebrew/">Homebrew</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/guide/binaries/">From the binaries</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/introduction/">Documentation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/questdb/questdb" target="_blank" rel="noopener noreferrer" class="menu__link navbar__item--github">GitHub</a></li></ul></div></div></div></nav><div class="wrapper_1hNx"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Things we learned about sums</h1><div class="margin-vert--md"><time datetime="2020-05-12T00:00:00.000Z" class="blogPostDate_3bQP">May 12, 2020  · 9 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/TheTanc" target="_blank" rel="noreferrer noopener"><img src="https://avatars.githubusercontent.com/TheTanc" alt="Tancrede Collard"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/TheTanc" target="_blank" rel="noreferrer noopener">Tancrede Collard</a></h4><small class="avatar__subtitle">QuestDB Team</small></div></div></header><section class="markdown"><img alt="Wile E. Coyote and the Road Runner cartoon" class="banner" src="/img/blog/2020-05-12/banner.png"><p>In the world of databases, benchmarking performance has always been the hottest
topic. Who is faster for data ingestion and queries? About a month ago we
announced a new release with SIMD aggregations on
<a href="https://news.ycombinator.com/item?id=22803504" target="_blank" rel="noopener noreferrer">HackerNews</a> and
<a href="https://www.reddit.com/r/programming/comments/fwlk0k/questdb_using_simd_to_aggregate_billions_of/" target="_blank" rel="noopener noreferrer">Reddit</a>.
Fast. But were those results numerically accurate?</p><p>Speed is not everything. Some of the feedback we have received pointed us toward
the accuracy of our results. This is something typically overlooked in the
space, but our sums turned out to be &quot;naive&quot;, with small errors for large
computations. By compounding a very small error over and over through a set of
operations, it can eventually become significant enough for people to start
worrying about it.</p><p>We then went on to include an accurate summation algorithm (such as &quot;Kahan&quot; and
&quot;Neumaier&quot; compensated sums). Now that we&#x27;re doing the sums accurately, we
wanted to see how it affected performance. There is typically a trade-off
between speed and accuracy. However, by extracting even more performance out of
QuestDB (see below for how we did it), we managed to compute accurate sums as
fast as naive ones! Since comparisons to Clickhouse have been our most frequent
question, we have run the numbers and the result is:
<a href="#comparison-with-clickhouse">2x faster for summing 1bn doubles will nulls</a>.</p><p>All of this is included in our new
<a href="https://github.com/questdb/questdb/releases/tag/4.2.1" target="_blank" rel="noopener noreferrer">release 4.2.1</a></p><p>You can find our repository on <a href="https://github.com/questdb/questdb" target="_blank" rel="noopener noreferrer">GitHub</a>. All your
<a href="https://github.com/questdb/questdb/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc" target="_blank" rel="noopener noreferrer">issues</a>,
<a href="https://github.com/questdb/questdb/pulls?q=is%3Apr+is%3Aopen+sort%3Aupdated-desc" target="_blank" rel="noopener noreferrer">pull-requests</a> and
<a href="https://github.com/questdb/questdb" target="_blank" rel="noopener noreferrer">stars</a> are welcome 🙂.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-did-we-get-there-tldr"></a>How did we get there? TL;DR<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-did-we-get-there-tldr" title="Direct link to heading">#</a></h2><p>We used prefetch and co-routines techniques to pull data from RAM to cache in
parallel with other CPU instructions. Our performance was previously limited by
memory bandwidth - using these techniques would address this and allow us to
compute accurate sums as fast as naive sums.</p><p>With the help of prefetch we implemented the fastest and most accurate summation
we have ever <a href="#comparison-with-clickhouse">tested</a> - 68ms over 1bn double values
with nulls (versus 139ms for Clickhouse). We believe this is a significant
advance in terms of performance for accurate summations, and will help
developers handling intensive computations with large datasets.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="contents"></a>Contents<a aria-hidden="true" tabindex="-1" class="hash-link" href="#contents" title="Direct link to heading">#</a></h2><ul><li>An <a href="#inaccurate-summation">introductory example</a> of the problem with summing
doubles.</li><li>A <a href="#float-representation-and-truncation-accuracy-loss">quick glance</a> at
floating points inaccuracies.</li><li>A <a href="#kahans-algorithm-for-compensated-summation">presentation</a> of the Kahan
algorithm.</li><li>Our <a href="#implementation-with-simd-instructions">compensated sum implementation</a>
using SIMD instructions.</li><li>A <a href="#comparison-with-clickhouse">benchmark versus Clickhouse</a> for naive and
accurate summation methods.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="inaccurate-summation"></a>Inaccurate summation?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#inaccurate-summation" title="Direct link to heading">#</a></h2><p>Before we dig in, some of you might wonder how an addition can be inaccurate as
opposed to simply right or wrong.</p><p>CPUs are poor at dealing with floating-point values. Arithmetics are almost
always wrong, with a worst-case error proportional to the number of operations
<code>n</code>. As floating-point operations are intransitive, the order in which you
perform them also has an impact on accuracy.</p><p>Here is an example:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">static</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">void</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#50fa7b">5.1</span><span class="token operator" style="color:#ff79c6">+</span><span class="token number" style="color:#50fa7b">9.2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><p>We ask to add <code>5.1</code> to <code>9.2</code>. The result should be <code>14.3</code>, but we get the
following instead.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-questdb-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">14.299999999999999</span></div></div></div></div></div><p>It is a small difference (only <code>0.000000000000001</code>), but it is still wrong. To
make matters worse, this error can be compounded.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">static</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">void</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">double</span><span class="token plain"> a </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">5.1</span><span class="token operator" style="color:#ff79c6">+</span><span class="token number" style="color:#50fa7b">9.2</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">double</span><span class="token plain"> b </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> a </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">3.5</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">double</span><span class="token plain"> c </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">14.3</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">3.5</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;The result is: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> b</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">print</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;But we expected: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-questdb-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">The result is: 17.799999999999997</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">But we expected: 17.8</span></div></div></div></div></div><p>The error has just grown to <code>0.000000000000003</code> and will keep on growing as we
add operations.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="float-representation-and-truncation-accuracy-loss"></a>Float representation and truncation accuracy loss<a aria-hidden="true" tabindex="-1" class="hash-link" href="#float-representation-and-truncation-accuracy-loss" title="Direct link to heading">#</a></h2><p>Decimal numbers are not accurately stored. This is well documented already, for
example on
<a href="https://stackoverflow.com/questions/588004/is-floating-point-math-broken/588014#588014" target="_blank" rel="noopener noreferrer">StackOverlow</a>
or <a href="https://0.30000000000000004.com" target="_blank" rel="noopener noreferrer">0.30000000000000004.com</a>.</p><p>Consequently, operations on floating points will return inaccurate results. This
is not the only problem. Performing operations is also likely to introduce more
errors and to grow the total error over time. One such case is once the result
of an operation has to be truncated to fit the original format. Here is a
simplified example of the <strong>truncation</strong> that happens when adding floats of
different orders of magnitude.</p><blockquote><p>For the below example we will be using base 10 and expressing the exponent as
a number rather than a binary for sake of simplicity. We assume 5 significant
digits.</p></blockquote><p>We start with both our numbers expressed in scientific notation.</p><p><img alt="Numbers expressed in scientific notation" src="/assets/images/significantDigits-35f31cbf78ee69d254ac95ac9a5eb84a.png"></p><p>Let&#x27;s expand into decimal notation and place them on a similar scale so all
digits fit.</p><p><img alt="Numbers expressed in decimal notation" src="/assets/images/digitsExpanded-3a266315a5bed656c8de128266d5f9ff.png"></p><p>Now, let us express this sum back as one number in scientific notation. We have
to <code>truncate</code> the result back to 5 significant digits.</p><p><img alt="A number expressed in 2 parts: the significant digits and the truncated part" src="/assets/images/digitsResult-5e5cff4654a26272384864c4ca550fc9.png"></p><p>The result is incorrect. In fact, it is as if we did not sum anything.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="kahans-algorithm-for-compensated-summation"></a>Kahan&#x27;s algorithm for compensated summation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#kahans-algorithm-for-compensated-summation" title="Direct link to heading">#</a></h2><p>Compensated sum maintains a sum of accumulated errors and uses it to attempt to
correct the (inaccurate) sum by the total error amount. It does so by trying to
adjust each new number by the total accumulated error.</p><p>The main Compensated summation algorithm is the
<a href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm" target="_blank" rel="noopener noreferrer">Kahan</a> sum. It runs in
4 steps:</p><ul><li>Subtract the <code>running error</code> from the new <code>number</code> to get the
<code>adjusted number</code>. If this is the first number, then the running error is 0.</li><li>Add the <code>adjusted number</code> to the <code>running total</code> and truncate to the number of
significant digits. This is the <code>truncated result</code>.</li><li>Calculate the <code>new running error</code> as
<code>(truncated result - running total) - adjusted number</code>.</li><li>Assign the <code>truncated result</code> as the new <code>running total</code>.</li></ul><p>This works because of addition transitivity rules.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="implementation-with-simd-instructions"></a>Implementation with SIMD instructions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#implementation-with-simd-instructions" title="Direct link to heading">#</a></h2><p>Now, the interesting bit! QuestDB implements the same 4-step algorithm as Kahan.
However, it uses vectorized instructions to make things a lot faster. The idea
came from Zach Bjornson who wrote about this on
<a href="https://blog.zachbjornson.com/2019/08/11/fast-float-summation.html" target="_blank" rel="noopener noreferrer">his blog</a>.</p><p>Here is our implementation in details:</p><p>We first define our vectors:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token class-name">Vec8d</span><span class="token plain"> inputVec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">int</span><span class="token plain"> step </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">8</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> auto </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">lim </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> d </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> count</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> auto remainder </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">int32_t</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">count </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">count </span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain"> step</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> step</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">const</span><span class="token plain"> auto </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">lim_vec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> lim </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> remainder</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name">Vec8d</span><span class="token plain"> sumVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0.</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name">Vec8d</span><span class="token plain"> yVec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name">Vec8d</span><span class="token plain"> cVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0.</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name">Vec8db</span><span class="token plain"> bVec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name">Vec8q</span><span class="token plain"> nancount </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token class-name">Vec8d</span><span class="token plain"> tVec</span><span class="token punctuation" style="color:#f8f8f2">;</span></div></div></div></div></div><p>Then we load vectors with data. What&#x27;s happening below is exactly Kahan&#x27;s
algorithm. However, instead of summing individual values, we are summing vectors
of 8 values each.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> d </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> lim_vec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> d </span><span class="token operator" style="color:#ff79c6">+=</span><span class="token plain"> step</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">_mm_prefetch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">d </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">63</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> step</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> _MM_HINT_T1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    inputVec</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">load</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">d</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    bVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">is_nan</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">inputVec</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    nancount </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">if_add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bVec</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> nancount</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    yVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">select</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">bVec</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> inputVec </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> cVec</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    tVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> sumVec </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> yVec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    cVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">tVec </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> sumVec</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> yVec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    sumVec </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> tVec</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><p>The strategically placed <code>prefetch</code> relies on CPU pipelining. The goal is to
have the CPU fetching the next chunk of data from RAM to cache while we are
calculating the current vector.</p><p>Lastly, we use <code>horizontal_add</code> to sum all values into a scalar value. Again, we
recognise Kahan&#x27;s sum algorithm.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-java codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">double</span><span class="token plain"> sum </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">horizontal_add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">sumVec</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">double</span><span class="token plain"> c </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">horizontal_add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cVec</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">int</span><span class="token plain"> nans </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">horizontal_add</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">nancount</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> d </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> lim</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> d</span><span class="token operator" style="color:#ff79c6">++</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">double</span><span class="token plain"> x </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">d</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">x </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> x</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        auto y </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> x </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        auto t </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> sum </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        c </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">t </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> sum</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">y</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        sum </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        nans</span><span class="token operator" style="color:#ff79c6">++</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="comparison-with-clickhouse"></a>Comparison with Clickhouse<a aria-hidden="true" tabindex="-1" class="hash-link" href="#comparison-with-clickhouse" title="Direct link to heading">#</a></h2><p>We compared how performance behaves when switching from naive (inaccurate) sum
to Kahan compensated sum.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="hardware"></a>Hardware<a aria-hidden="true" tabindex="-1" class="hash-link" href="#hardware" title="Direct link to heading">#</a></h3><p>We run all databases on an <code>c5.metal</code> AWS instance, which has two Intel 8275CL
24-core CPUs and 192GB of memory. QuestDB was running on 16 threads. As we
showed in a
<a href="/blog/2020/04/02/using-simd-to-aggregate-billions-of-rows-per-second">previous article</a>,
adding more threads does not improve performance beyond a certain point.
Clickhouse was running using all cores as per default configuration, however we
increased the memory limit from the default value from 10GB to 40GB
<code>&lt;max_memory_usage&gt;40000000000&lt;/max_memory_usage&gt;</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="test-data"></a>Test data<a aria-hidden="true" tabindex="-1" class="hash-link" href="#test-data" title="Direct link to heading">#</a></h3><p>We generated two test files using our
<a href="/docs/reference/function/random-value-generator/">random generation functions</a>
and exported the results to CSV. We then imported the CSV individually in the
databases.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-questdb-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT rnd_double() FROM long_sequence(1_000_000_000l); -- non null</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">SELECT rnd_double(2) FROM long_sequence(1_000_000_000l); -- with nulls</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="storage-engine"></a>Storage engine<a aria-hidden="true" tabindex="-1" class="hash-link" href="#storage-engine" title="Direct link to heading">#</a></h3><ul><li><strong>QuestDB</strong>: on disk</li><li><strong>Clickhouse</strong>: in memory (using the <code>memory()</code> engine)</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="commands"></a>Commands<a aria-hidden="true" tabindex="-1" class="hash-link" href="#commands" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="with-null"></a>With null<a aria-hidden="true" tabindex="-1" class="hash-link" href="#with-null" title="Direct link to heading">#</a></h4><table><thead><tr><th>Description</th><th>QuestDB</th><th>Clickhouse</th></tr></thead><tbody><tr><td>DDL</td><td><code>CREATE TABLE test_double AS(SELECT rnd_double() FROM long_sequence(1000000000L);</code></td><td><code>CREATE TABLE test_double (val Nullable(Float64)) Engine=Memory;</code></td></tr><tr><td>Import</td><td>Not required</td><td><code>clickhouse-client --query=&quot;INSERT INTO test_double FORMAT CSVWithNames;&quot; &lt; test_double.csv</code></td></tr><tr><td>Naive sum</td><td><code>SELECT sum(val) FROM test_double;</code></td><td><code>SELECT sum(val) FROM test_double;</code></td></tr><tr><td>Kahan sum</td><td><code>SELECT ksum(val) FROM test_double;</code></td><td><code>SELECT sumKahan(val) FROM test_double;</code></td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="non-null"></a>Non-null<a aria-hidden="true" tabindex="-1" class="hash-link" href="#non-null" title="Direct link to heading">#</a></h4><p>For non-null values, we adjusted the commands as follows:</p><ul><li>use <code>test_double_not_nul.csv</code> instead of <code>test_double.csv</code>.</li><li>for Clickhouse, skip declaring val as <code>nullable</code>:
<code>CREATE TABLE test_double_not_null (val Float64) Engine=Memory;</code>.</li><li>for QuestDB, replace <code>rnd_double()</code> by <code>rnd_double(2)</code> at the DDL step.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="results"></a>Results<a aria-hidden="true" tabindex="-1" class="hash-link" href="#results" title="Direct link to heading">#</a></h3><p>We ran each query several times for both QuestDB and Clickhouse and kept the
best result.</p><p>Without null values, both databases sum naively at roughly the same speed. With
Kahan summation, QuestDB performs at the same speed while Clickhouse&#x27;s
performance drops by ~40%.</p><p><img alt="QuestDB vs Clickhouse benchmark for Kahan&#x27;s sums" src="/assets/images/kahanComparison-a120ecf15e76c693a639fc0af3908687.png"></p><p>As we include null values, Clickhouse&#x27;s performance degrades by 28% and 50% for
naive and Kahan summation, respectively.</p><p><img alt="QuestDB vs Clickhouse benchmark for Kahan&#x27;s sums with nulls" src="/assets/images/kahanNullComparison-ce562d8fa2cafb5e8f02a72ca8b49f6b.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="concluding-remarks"></a>Concluding remarks<a aria-hidden="true" tabindex="-1" class="hash-link" href="#concluding-remarks" title="Direct link to heading">#</a></h2><p>It is useful to stabilize aggregation with compensated sums. We learned that
vector-based calculation produce different arithmetic errors compared to
non-vector calculations. The way the aggregation is executed by multiple threads
is not constant. This can cause results to be different from one SQL run to
another, if the sum is accuracy naive. Through compensated sums, the results are
consistent and more accurate.</p><p>It was also both interesting and surprising to be able to quantify the effect of
prefetch on what is essentially sequential memory read.</p><p>Your support means a lot to us! If you like content like this, what we do, and
where we&#x27;re going, please <a href="https://slack.https://fsharechat.github.io/" target="_blank" rel="noopener noreferrer">join our community</a> and give us a
<a href="https://github.com/questdb/questdb" target="_blank" rel="noopener noreferrer">star️</a> on GitHub.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/performance">performance</a><a class="margin-horiz--sm" href="/blog/tags/deep-dive">deep-dive</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2020/06/05/iot-on-questdb"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« IoT on QuestDB</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2020/04/02/using-simd-to-aggregate-billions-of-rows-per-second"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Aggregating billions of rows per sec with SIMD »</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-did-we-get-there-tldr" class="table-of-contents__link">How did we get there? TL;DR</a></li><li><a href="#contents" class="table-of-contents__link">Contents</a></li><li><a href="#inaccurate-summation" class="table-of-contents__link">Inaccurate summation?</a></li><li><a href="#float-representation-and-truncation-accuracy-loss" class="table-of-contents__link">Float representation and truncation accuracy loss</a></li><li><a href="#kahans-algorithm-for-compensated-summation" class="table-of-contents__link">Kahan&#39;s algorithm for compensated summation</a></li><li><a href="#implementation-with-simd-instructions" class="table-of-contents__link">Implementation with SIMD instructions</a></li><li><a href="#comparison-with-clickhouse" class="table-of-contents__link">Comparison with Clickhouse</a><ul><li><a href="#hardware" class="table-of-contents__link">Hardware</a></li><li><a href="#test-data" class="table-of-contents__link">Test data</a></li><li><a href="#storage-engine" class="table-of-contents__link">Storage engine</a></li><li><a href="#commands" class="table-of-contents__link">Commands</a></li><li><a href="#results" class="table-of-contents__link">Results</a></li></ul></li><li><a href="#concluding-remarks" class="table-of-contents__link">Concluding remarks</a></li></ul></div></div></div></div></div><footer class="footer_mib0 section_3Kiu"><div class="footer__inner_z0Le section--inner_2xOo"><div class="footer__column_3Npq footer__column--left_1EuR"><img alt="QuestDB logo" class="footer__logo_29Wo" src="/img/footer/questdb.svg" title="QuestDB - Fastest open source database for time series and analytics"><p class="footer__tagline_2F15">QuestDB is the fastest open source time series database</p><a class="footer__github_8UHO button_Ni2_ button--icon_3YKU button--secondary_1x2U button--xsmall_3jz_" href="https://github.com/questdb/questdb" rel="noopener noreferrer" target="_blank"><img alt="GitHub logo" height="22" src="/img/github.svg" title="GitHub" width="22">Star us on GitHub</a></div><div class="footer__column_3Npq footer__column--right_1XPX"><div class="footer__links_3WB8"><ul class="footer__items_3gGI"><li class="footer__title_1y7h">QuestDB</li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/docs/introduction/">Documentation</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://github.com/questdb/questdb/projects/3" rel="noopener noreferrer" target="_blank">Roadmap</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/careers/">Careers</a></li></ul></div><div class="footer__links_3WB8"><ul class="footer__items_3gGI"><li class="footer__title_1y7h">Community</li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://slack.https://fsharechat.github.io/" rel="noopener noreferrer" target="_blank">Slack</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://twitter.com/questdb" rel="noopener noreferrer" target="_blank">Twitter</a></li></ul></div><div class="footer__links_3WB8"><ul class="footer__items_3gGI"><li class="footer__title_1y7h">More</li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/blog/">Blog</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://github.com/questdb/questdb" rel="noopener noreferrer" target="_blank">GitHub</a></li></ul></div></div></div><div class="footer__bottom_2RpL"><p class="footer__copyright_1o2i">Copyright © 2020 QuestDB</p></div></footer></div>
<script src="/styles.c1a63971.js" defer="defer"></script>
<script src="/main.6f3bf291.js" defer="defer"></script>
<script src="/common.3d2125a2.js" defer="defer"></script>
<script src="/ccc49370.e8c9b56c.js" defer="defer"></script>
<script src="/535f65dd.f4e787ed.js" defer="defer"></script>
</body>
</html>